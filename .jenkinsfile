pipeline {
    agent none

    environment {
        HL_WEBHOOK_URL = credentials('HULALOOP_WEBHOOK_URL')
    }

    options {
        timeout(time: 10, unit: 'MINUTES')
        timestamps()
    }

    stages {

        stage('Initialization') {

            parallel {

                stage('Configuration') {
                    steps {
                        script {
                            currentBuild.displayName = env.BRANCH_NAME + " - #" + env.BUILD_NUMBER
                        }
                    }
                }

                //************
                //   LINUX
                //************
                stage('Linux') {
                    agent {
                        label 'linux'
                    }
                    environment {
                        HL_OS = 'Linux'
                    }

                    stages {

                        // Generate CMake and build any required dependencies
                        stage('Dependencies - Linux') {

                            steps {

                                sh '''
                                    echo "Building dependencies for ${HL_OS}..."
                                '''

                            }

                        }

                        // Build our application
                        stage('Build - Linux') {

                            steps {

                                sh '''
                                    echo "Building application for ${HL_OS}..."
                                '''

                            }

                        }

                        // Run the test suite
                        stage('Test - Linux') {

                            steps {

                                sh '''
                                    echo "Running test suite on ${HL_OS}..."
                                '''

                            }

                        }

                    } // END stages

                    post {
                        always {
                            sh '''
                                curl https://raw.githubusercontent.com/symboxtra/universal-ci-discord-webhook/master/send.sh > send.sh && chmod +x send.sh
                            '''
                        }
                        success {
                            sh '''
                                ./send.sh success $HL_WEBHOOK_URL
                            '''
                        }
                        failure {
                            sh '''
                                ./send.sh failure $HL_WEBHOOK_URL
                            '''
                        }
                    } // END post

                } // END Linux


                //************
                //    OSX
                //************
                stage ('OSX') {
                    agent {
                        label 'osx'
                    }
                    environment {
                        HL_OS = 'OSX'
                    }

                    stages {

                        stage('Dependencies - OSX') {

                            steps {

                                sh '''
                                    echo "Building dependencies for ${HL_OS}..."
                                '''

                            }

                        }

                        stage('Build - OSX') {

                            steps {

                                sh '''
                                    echo "Building application for ${HL_OS}..."
                                '''

                            }

                        }

                        stage('Test - OSX') {

                            steps {

                                sh '''
                                    echo "Running test suite on ${HL_OS}..."
                                '''

                            }

                        }
                    } // END stages

                    post {
                        always {
                            sh '''
                                curl https://raw.githubusercontent.com/symboxtra/universal-ci-discord-webhook/master/send.sh > send.sh && chmod +x send.sh
                            '''
                        }
                        success {
                            sh '''
                                ./send.sh success $HL_WEBHOOK_URL
                            '''
                        }
                        failure {
                            sh '''
                                ./send.sh failure $HL_WEBHOOK_URL
                            '''
                        }
                    } // END post

                } // END OSX


                //************
                //  WINDOWS
                //************
                stage ('Windows') {
                    agent {
                        label 'windows'
                    }
                    environment {
                        HL_OS = 'Windows'
                    }

                    stages {

                        stage('Dependencies - Windows') {

                            steps {

                                powershell '''
                                    echo "Building dependencies for ${HL_OS}..."
                                '''

                            }

                        }

                        stage('Build - Windows') {

                            steps {

                                powershell '''
                                    echo "Building application for ${HL_OS}..."
                                '''

                            }

                        }

                        stage('Test - Windows') {

                            steps {

                                powershell '''
                                    echo "Running test suite on ${HL_OS}..."
                                '''

                            }

                        }
                    } // END stages

                    post {
                        always {
                            powershell '''
                                Invoke-RestMethod https://raw.githubusercontent.com/symboxtra/universal-ci-discord-webhook/master/send.ps1 -o send.ps1
                            '''
                        }
                        success {
                            powershell '''
                                ./send.ps1 success $env:HL_WEBHOOK_URL
                            '''
                        }
                        failure {
                            powershell '''
                                ./send.ps1 failure $env:HL_WEBHOOK_URL
                            '''
                        }
                    } // END post

                } // END Windows

            } // END parallel

        } // END configuration

    } // END stages

} // END pipeline

